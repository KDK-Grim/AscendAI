<script>
  const githubSlug = (text) =>
    text.toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');

  marked.setOptions({
    headerIds: true,
    headerPrefix: '',
    mangle: false,
    slugger: {
      slug: githubSlug
    }
  });

  fetch('README.md')
    .then(res => res.ok ? res.text() : Promise.reject('README fetch failed'))
    .then(md => {
      const container = document.getElementById('readme');
      container.innerHTML = marked.parse(md);

      // Safe post-render substitution
      container.querySelectorAll('p').forEach(p => {
        const match = p.textContent.trim().match(/^\[!(NOTE|TIP|WARNING|IMPORTANT|CAUTION)\]/i);
        if (match) {
          const type = match[1].toLowerCase();
          const emojiMap = {
            note: 'üîµ',
            tip: 'üí°',
            warning: '‚ö†Ô∏è',
            important: 'üü£',
            caution: 'üî¥'
          };
          const label = match[1].charAt(0) + match[1].slice(1).toLowerCase();
          const rest = p.innerHTML.replace(/^\[!\w+\]/, '').trim();
          const div = document.createElement('div');
          div.className = `admonition admonition-${type}`;
          div.innerHTML = `<div class="admonition-title">${emojiMap[type]} ${label}</div><p>${rest}</p>`;
          p.replaceWith(div);
        }
      });

      // Header ID + scroll logic
      container.querySelectorAll('h1, h2, h3, h4, h5, h6').forEach(header => {
        if (!header.id) {
          const id = githubSlug(header.textContent);
          header.id = id;
        }
      });

      container.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
          const target = document.getElementById(this.getAttribute('href').slice(1));
          if (target) {
            e.preventDefault();
            target.scrollIntoView({ behavior: 'smooth' });
            history.pushState(null, null, this.getAttribute('href'));
          }
        });
      });

      VANTA.NET({
        el: "#vanta-bg",
        mouseControls: true,
        touchControls: true,
        gyroControls: false,
        color: 0xff0000,
        backgroundColor: 0x000000
      });

      const fxScript = document.createElement('script');
      fxScript.src = 'docs/scrollFX.js';
      document.body.appendChild(fxScript);
    })
    .catch(err => {
      console.error(err);
      document.getElementById('readme').innerHTML = "<p style='color:red'>Error loading README.md</p>";
    });
</script>
